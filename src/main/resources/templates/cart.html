<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Giỏ hàng</title>
  <link rel="stylesheet" href="/css/cart.css">
</head>
<body>

<header class="site-header">
  <div class="logo">
    <a href="/view/home"><img src="/images/main-logo.png" alt="Logo" /></a>
  </div>
  <nav class="main-nav">
    <a href="/view/home">Trang chủ</a>
    <a href="/view/shop.html">Mua sắm</a>
    <a href="/view/cart" class="active">Giỏ hàng</a>
    <a href="/view/profile">Tài khoản</a>
  </nav>
</header>

<main class="cart-container">
  <h1>Giỏ hàng của bạn</h1>

  <div id="cartItems"></div>

  <div class="cart-summary">

    <label for="deliveryAddress" class="address-label">Địa chỉ giao hàng</label>
    <textarea id="deliveryAddress" class="address-input" placeholder="Nhập địa chỉ nhận hàng..."></textarea>

    <div class="cart-total" id="cartTotal">Tổng: 0₫</div>

    <button class="submit-button" onclick="submitOrder()">Đặt hàng</button>
  </div>
</main>

<script>
  let cart = [];

  const token = localStorage.getItem("accessToken");

  if (!token) {
    alert("Bạn cần đăng nhập để xem giỏ hàng.");
    window.location.href = "/view/login";
  }

  function loadCart() {
    fetch("/cart/items", {
      method: "GET",
      headers: { "Authorization": `Bearer ${token}` }
    })
    .then(res => res.json())
    .then(data => { cart = data; renderCart(); })
    .catch(err => { console.error(err); alert("Lỗi khi tải giỏ hàng"); });
  }

  function renderCart() {
    const container = document.getElementById("cartItems");
    const totalEl = document.getElementById("cartTotal");

    if (cart.length === 0) {
      container.innerHTML = "<p class='empty-cart'>Giỏ hàng trống.</p>";
      totalEl.textContent = "Tổng: 0₫";
      return;
    }

    let total = 0;

    container.innerHTML = cart.map(item => {
      const subtotal = item.productPrice * item.quantity;
      total += subtotal;

      return `
        <div class="cart-item">
          <div class="cart-info">
            <img src="/${item.productImage}" alt="${item.productName}" class="product-img">
            <div class="product-details">
              <div class="product-name">${item.productName}</div>
              <div class="product-price">${item.productPrice.toLocaleString()}₫</div>
            </div>
          </div>
          <div class="quantity-controls">
            <button onclick="updateQuantity(${item.productId}, -1)">−</button>
            <span>${item.quantity}</span>
            <button onclick="updateQuantity(${item.productId}, 1)">+</button>
          </div>
          <div class="subtotal">${subtotal.toLocaleString()}₫</div>
          <button class="remove-button" onclick="removeItem(${item.productId})">X</button>
        </div>
      `;
    }).join("");

    totalEl.textContent = "Tổng: " + total.toLocaleString() + "₫";
  }

  function updateQuantity(productId, change) {
    const item = cart.find(p => p.productId === productId);
    if (!item) return;
    let newQuantity = Math.max(1, item.quantity + change);

    fetch("/cart/update", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ productId, quantity: newQuantity })
    })
    .then(() => { item.quantity = newQuantity; renderCart(); })
    .catch(err => console.error(err));
  }

  function removeItem(productId) {
    fetch("/cart/remove", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ productId })
    })
    .then(() => { cart = cart.filter(i => i.productId !== productId); renderCart(); })
    .catch(err => console.error(err));
  }

  function submitOrder() {
    const address = document.getElementById("deliveryAddress").value.trim();

    if (address.length < 5) {
        alert("Vui lòng nhập địa chỉ giao hàng hợp lệ!");
        return;
    }

    fetch("/api/orders", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ deliveryAddress: address })
    })
    .then(res => {
        if (!res.ok) throw new Error("Order failed");
        return res.json();
    })
    .then(data => {
        alert("Đặt hàng thành công! Mã đơn: " + data.id);
        cart = [];
        renderCart();
        document.getElementById("deliveryAddress").value = "";
    })
    .catch(err => {
        console.error(err);
        alert("Đặt hàng thất bại!");
    });
  }

  loadCart();
</script>

</body>
</html>
